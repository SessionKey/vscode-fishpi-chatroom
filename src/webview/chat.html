<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÅäÂ§©ÂÆ§</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: var(--vscode-font-family);
            background: var(--vscode-editor-background);
            color: var(--vscode-editor-foreground);
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
        }

        .control-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--vscode-editor-background);
            padding: 8px;
            border-bottom: 1px solid var(--vscode-editor-lineHighlightBorder);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .message-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            margin-top: 40px;
            margin-bottom: 60px;
        }

        .message-item {
            display: flex;
            margin-bottom: 16px;
            width: 100%;
            gap: 8px;
        }

        .message-item.self {
            flex-direction: row-reverse;
        }

        .message-item.no-avatar {
            margin-left: 0;
        }

        .avatar-container {
            flex-shrink: 0;
            width: 48px;
            height: 48px;
        }

        .avatar {
            width: 100%;
            height: 100%;
            border-radius: 4px;
        }

        .message-content {
            flex: 1;
            max-width: 80%;
            background: var(--vscode-editor-inactiveSelectionBackground);
            padding: 8px;
            border-radius: 4px;
        }

        .no-avatar .message-content {
            max-width: 100%;
        }

        .username {
            font-weight: bold;
            margin-bottom: 4px;
            color: var(--vscode-editor-selectionForeground);
        }

        .content {
            word-break: break-word;
        }

        .message-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 4px;
            margin: 4px 0;
        }

        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background: var(--vscode-editor-background);
            border-top: 1px solid var(--vscode-editor-lineHighlightBorder);
            display: flex;
            gap: 8px;
        }

        .hidden {
            display: none !important;
        }

        .self .message-content {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }

        #messageInput {
            flex: 1;
            padding: 8px;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            border-radius: 4px;
            font-family: inherit;
        }

        button {
            padding: 8px 16px;
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: var(--vscode-button-hoverBackground);
        }

        .login-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 20px;
            max-width: 300px;
            margin: 40px auto 0;
        }

        .login-container input {
            padding: 8px;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            border-radius: 4px;
            font-family: inherit;
        }

        .toggle {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            user-select: none;
        }

        .toggle input {
            margin: 0;
        }

        .emoji-button {
            padding: 8px;
            min-width: 40px;
        }

        .emoji-picker {
            position: absolute;
            bottom: 60px;
            left: 10px;
            background: var(--vscode-editor-background);
            border: 1px solid var(--vscode-editor-lineHighlightBorder);
            border-radius: 4px;
            padding: 8px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }

        .emoji-item {
            cursor: pointer;
            padding: 4px;
            text-align: center;
            border-radius: 4px;
        }

        .emoji-item:hover {
            background: var(--vscode-editor-inactiveSelectionBackground);
        }

        a {
            color: var(--vscode-textLink-foreground);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div id="loginForm" class="login-container">
        <h2>ÁôªÂΩïÊë∏È±ºÊ¥æ</h2>
        <input type="text" id="username" placeholder="Áî®Êà∑ÂêçÊàñÈÇÆÁÆ±">
        <input type="password" id="password" placeholder="ÂØÜÁ†Å">
        <button id="loginButton">ÁôªÂΩï</button>
    </div>

    <div id="chatContainer" class="chat-container hidden">
        <div class="control-panel">
            <label class="toggle">
                <input type="checkbox" id="showImagesToggle" checked>
                <span>ÊòæÁ§∫Â§¥ÂÉèÂíåÂõæÁâá</span>
            </label>
        </div>
        <div class="message-list" id="messageList">
            <!-- Ê∂àÊÅØÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÊ∑ªÂä† -->
        </div>
        <div class="input-container">
            <button class="emoji-button" id="emojiButton">üòä</button>
            <input type="text" id="messageInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ...">
            <button id="sendButton">ÂèëÈÄÅ</button>
        </div>
        <div id="emojiPicker" class="emoji-picker hidden">
            <!-- Ë°®ÊÉÖÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÊ∑ªÂä† -->
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        const loginForm = document.getElementById('loginForm');
        const chatContainer = document.getElementById('chatContainer');
        let currentUser = ''; // ‰øùÂ≠òÂΩìÂâçÁôªÂΩïÁî®Êà∑Âêç

        // È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
        vscode.postMessage({
            type: 'checkLoginStatus'
        });

        document.getElementById('loginButton').addEventListener('click', async () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                vscode.postMessage({
                    type: 'showError',
                    message: 'ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å'
                });
                return;
            }

            vscode.postMessage({
                type: 'login',
                username,
                password
            });
        });

        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (message) {
                vscode.postMessage({
                    type: 'sendMessage',
                    content: message
                });
                input.value = '';
            }
        }

        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.type) {
                case 'loginSuccess':
                case 'alreadyLoggedIn':
                    currentUser = message.username;
                    console.log('ÂΩìÂâçÁî®Êà∑:', currentUser);
                    loginForm.classList.add('hidden');
                    chatContainer.classList.remove('hidden');
                    messageList.innerHTML = '';
                    if (message.history && Array.isArray(message.history)) {
                        message.history.forEach(msg => addMessage(msg));
                    }
                    break;
                case 'notLoggedIn':
                    loginForm.classList.remove('hidden');
                    chatContainer.classList.add('hidden');
                    break;
                case 'receiveMessage':
                    addMessage(message.data);
                    break;
                case 'updateImageSetting':
                    showImagesToggle.checked = message.showImages;
                    updateImagesVisibility(message.showImages);
                    break;
            }
        });

        function addMessage(message) {
            const messageList = document.getElementById('messageList');
            const messageElement = document.createElement('div');
            messageElement.className = 'message-item';

            const isSelf = message.userName === currentUser;
            console.log('Ê∂àÊÅØÁî®Êà∑Âêç:', message.userName, 'ÂΩìÂâçÁî®Êà∑:', currentUser, 'ÊòØÂê¶Ëá™Â∑±:', isSelf);

            if (isSelf) {
                messageElement.classList.add('self');
            }

            if (!showImagesToggle.checked) {
                messageElement.classList.add('no-avatar');
            }

            messageElement.setAttribute('data-original-content', message.content);
            messageElement.setAttribute('data-username', message.userName);
            messageElement.setAttribute('data-nickname', message.userNickname);
            messageElement.setAttribute('data-avatar', message.userAvatarURL48);
            messageElement.setAttribute('data-is-self', isSelf);

            updateMessageContent(messageElement, message);

            messageList.appendChild(messageElement);
            messageList.scrollTop = messageList.scrollHeight;
        }

        function updateMessageContent(element, message) {
            const isSelf = element.getAttribute('data-is-self') === 'true';
            const showImages = showImagesToggle.checked;
            const username = element.getAttribute('data-username');
            const nickname = element.getAttribute('data-nickname');
            const avatarUrl = element.getAttribute('data-avatar');
            const content = element.getAttribute('data-original-content');

            // Ê∏ÖÁ©∫Áé∞ÊúâÂÜÖÂÆπ
            element.innerHTML = '';

            // Ê∑ªÂä†Â§¥ÂÉè
            if (showImages) {
                const avatarContainer = document.createElement('div');
                avatarContainer.className = 'avatar-container';
                const avatar = document.createElement('img');
                avatar.src = avatarUrl;
                avatar.alt = nickname || username;
                avatar.className = 'avatar';
                avatarContainer.appendChild(avatar);
                element.appendChild(avatarContainer);
            }

            // Ê∑ªÂä†Ê∂àÊÅØÂÜÖÂÆπÂÆπÂô®
            const contentContainer = document.createElement('div');
            contentContainer.className = 'message-content';

            // Ê∑ªÂä†Áî®Êà∑Âêç
            const usernameElement = document.createElement('div');
            usernameElement.className = 'username';
            usernameElement.textContent = nickname || username;
            contentContainer.appendChild(usernameElement);

            // Â§ÑÁêÜÊ∂àÊÅØÂÜÖÂÆπ
            const messageContent = document.createElement('div');
            messageContent.className = 'content';
            
            // Â§ÑÁêÜÂõæÁâáÈìæÊé•
            const imgRegex = /(https?:\/\/[^\s<]+?\.(?:jpg|jpeg|gif|png|webp))/gi;
            let processedContent = content;
            
            if (showImages) {
                processedContent = content.replace(imgRegex, (match) => {
                    return `<img src="${match}" class="message-image" alt="ËÅäÂ§©ÂõæÁâá">`;
                });
            } else {
                processedContent = content.replace(imgRegex, (match) => {
                    return `<a href="${match}" target="_blank">[ÂõæÁâá]</a>`;
                });
            }

            messageContent.innerHTML = processedContent;
            contentContainer.appendChild(messageContent);
            element.appendChild(contentContainer);

            // Ê†πÊçÆÊòØÂê¶ÊòæÁ§∫Â§¥ÂÉèÊ∑ªÂä†/ÁßªÈô§Áõ∏Â∫îÁöÑÁ±ª
            if (!showImages) {
                element.classList.add('no-avatar');
            } else {
                element.classList.remove('no-avatar');
            }
        }

        function updateImagesVisibility(show) {
            const messageItems = messageList.getElementsByClassName('message-item');

            for (const item of messageItems) {
                if (show) {
                    item.classList.remove('no-avatar');
                } else {
                    item.classList.add('no-avatar');
                }

                updateMessageContent(item, {
                    content: item.getAttribute('data-original-content'),
                    userName: item.getAttribute('data-username'),
                    userNickname: item.getAttribute('data-nickname'),
                    userAvatarURL48: item.getAttribute('data-avatar')
                });
            }
        }

        vscode.postMessage({
            type: 'getImageSetting'
        });

        const commonEmojis = [
            'üòä', 'üòÇ', 'ü§£', '‚ù§Ô∏è', 'üòç', 'ü§î', 'üòé', 'üòÖ',
            'üò≠', 'üòò', 'ü•∞', 'üòâ', 'üòã', 'ü§ó', 'üòê', 'üò∂',
            'üòè', 'üòÆ', 'üò±', 'üò®', 'üò∞', 'üò¢', 'üò•', 'üò§',
            'üò†', 'üò°', 'ü§¨', 'ü§Æ', 'ü§¢', 'ü§ï', 'ü§í', 'üò∑',
            'ü§ß', 'ü•µ', 'ü•∂', 'üò¥', 'ü§§', 'üò™', 'üòá', 'ü§†',
            'ü§°', 'ü•≥', 'üôÑ', 'üòà', 'üëø', 'üëπ', 'üë∫', 'üíÄ'
        ];

        const emojiPicker = document.getElementById('emojiPicker');
        commonEmojis.forEach(emoji => {
            const emojiElement = document.createElement('div');
            emojiElement.className = 'emoji-item';
            emojiElement.textContent = emoji;
            emojiElement.addEventListener('click', () => {
                const messageInput = document.getElementById('messageInput');
                messageInput.value += emoji;
                emojiPicker.classList.add('hidden');
                messageInput.focus();
            });
            emojiPicker.appendChild(emojiElement);
        });

        document.getElementById('emojiButton').addEventListener('click', () => {
            emojiPicker.classList.toggle('hidden');
        });

        document.addEventListener('click', (event) => {
            if (!event.target.closest('#emojiPicker') &&
                !event.target.closest('#emojiButton')) {
                emojiPicker.classList.add('hidden');
            }
        });

        const showImagesToggle = document.getElementById('showImagesToggle');
        const messageList = document.getElementById('messageList');

        showImagesToggle.addEventListener('change', () => {
            const messages = document.querySelectorAll('.message-item');
            messages.forEach(messageElement => {
                updateMessageContent(messageElement, {
                    content: messageElement.getAttribute('data-original-content'),
                    userName: messageElement.getAttribute('data-username'),
                    userNickname: messageElement.getAttribute('data-nickname'),
                    userAvatarURL48: messageElement.getAttribute('data-avatar')
                });
            });
        });
    </script>
</body>

</html>